# نظام إعادة تعيين كلمة المرور

## نظرة عامة
تم تنفيذ نظام آمن ومتكامل لإعادة تعيين كلمة المرور عبر البريد الإلكتروني.

## المكونات

### 1. قاعدة البيانات
- **جدول `sabq_password_reset_tokens`**:
  - `id`: معرف فريد
  - `userId`: معرف المستخدم
  - `token`: رمز إعادة التعيين (عشوائي 32 بايت)
  - `expiresAt`: وقت انتهاء الصلاحية (ساعة واحدة)
  - `used`: حالة الاستخدام
  - `createdAt`: وقت الإنشاء

### 2. API Endpoints

#### `/api/auth/forgot-password`
- **الطريقة**: POST
- **المعاملات**: `{ email }`
- **الوظيفة**: 
  - إنشاء رمز إعادة تعيين
  - إرسال بريد إلكتروني برابط إعادة التعيين
  - يرجع نفس الرسالة سواء وجد المستخدم أم لا (لأسباب أمنية)

#### `/api/auth/reset-password`
- **الطريقة**: POST
- **المعاملات**: `{ token, newPassword }`
- **الوظيفة**:
  - التحقق من صلاحية الرمز
  - تحديث كلمة المرور
  - حذف جميع جلسات المستخدم القديمة
  - تحديد الرمز كمستخدم

### 3. الصفحات

#### `/forgot-password`
- نموذج لإدخال البريد الإلكتروني
- رسالة نجاح بعد الإرسال
- رابط للعودة لتسجيل الدخول

#### `/reset-password`
- التحقق من وجود رمز صالح في URL
- نموذج لإدخال كلمة المرور الجديدة
- التحقق من تطابق كلمة المرور
- توجيه لصفحة تسجيل الدخول بعد النجاح

### 4. خدمة البريد الإلكتروني

#### في بيئة التطوير
- يعرض البريد في console.log
- لا يرسل بريد فعلي

#### في بيئة الإنتاج
- يستخدم إعدادات SMTP من متغيرات البيئة:
  - `SMTP_HOST`
  - `SMTP_PORT`
  - `SMTP_SECURE`
  - `SMTP_USER`
  - `SMTP_PASS`
  - `EMAIL_FROM`

## الأمان

1. **الرموز العشوائية**: استخدام `crypto.randomBytes(32)` لتوليد رموز آمنة
2. **انتهاء الصلاحية**: الرموز صالحة لساعة واحدة فقط
3. **الاستخدام مرة واحدة**: لا يمكن استخدام الرمز أكثر من مرة
4. **حذف الجلسات**: حذف جميع جلسات المستخدم بعد تغيير كلمة المرور
5. **عدم كشف المعلومات**: نفس الرسالة سواء وجد البريد أم لا

## تصميم البريد الإلكتروني

- تصميم HTML متجاوب
- يدعم اللغة العربية (RTL)
- ألوان متناسقة مع العلامة التجارية
- رسالة تحذيرية واضحة
- رابط بديل للنسخ واللصق

## التحسينات المستقبلية

1. **معدل الطلبات**: تحديد عدد طلبات إعادة التعيين لكل مستخدم
2. **سجل الأنشطة**: تسجيل جميع محاولات إعادة التعيين
3. **التحقق بخطوتين**: إضافة رمز تحقق إضافي
4. **تنبيهات الأمان**: إشعار المستخدم عند تغيير كلمة المرور 