# تطبيق نظام تسجيل الخروج

## الملخص
تم تطبيق نظام تسجيل خروج كامل للوحة التحكم مع حذف الجلسات وإعادة التوجيه لصفحة تسجيل الدخول.

## التحديثات المطبقة

### 1. إنشاء API Endpoint لتسجيل الخروج
**الملف:** `/app/api/auth/logout/route.ts`

**المميزات:**
- حذف جميع جلسات المستخدم من قاعدة البيانات
- حذف الكوكيز (auth-token و user)
- التعامل مع الأخطاء بشكل آمن
- تسجيل العمليات في console

```typescript
// حذف جلسات المستخدم
await prisma.sabq_sessions.deleteMany({
  where: { userId: decoded.id }
})

// حذف الكوكيز
response.cookies.set('auth-token', '', { maxAge: 0 })
response.cookies.set('user', '', { maxAge: 0 })
```

### 2. تحديث لوحة التحكم
**الملف:** `/app/dashboard/page.tsx`

**الإضافات:**
- زر تسجيل خروج في الشريط العلوي
- دالة `handleLogout` للتعامل مع عملية الخروج
- حذف البيانات من localStorage
- إعادة التوجيه مع معامل logout

```typescript
const handleLogout = async () => {
  // استدعاء API
  await fetch('/api/auth/logout', { method: 'POST' })
  // حذف البيانات المحلية
  localStorage.removeItem('token')
  localStorage.removeItem('user')
  // إعادة التوجيه
  router.push('/login?logout=true')
}
```

### 3. تحديث صفحة تسجيل الدخول
**الملف:** `/app/login/page.tsx`

**الإضافات:**
- عرض رسالة نجاح عند تسجيل الخروج
- إخفاء الرسالة تلقائياً بعد 3 ثواني
- دعم معامل `logout` في URL

```tsx
{showLogoutMessage && (
  <div className="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
    تم تسجيل الخروج بنجاح
  </div>
)}
```

## تدفق العمليات

### عند النقر على زر تسجيل الخروج:
1. **استدعاء API:** يتم إرسال طلب POST إلى `/api/auth/logout`
2. **التحقق من التوكن:** التحقق من صحة التوكن وجلب معرف المستخدم
3. **حذف الجلسات:** حذف جميع جلسات المستخدم من قاعدة البيانات
4. **حذف الكوكيز:** إزالة auth-token و user cookies
5. **حذف البيانات المحلية:** إزالة token و user من localStorage
6. **إعادة التوجيه:** التوجيه إلى `/login?logout=true`
7. **عرض رسالة النجاح:** عرض رسالة "تم تسجيل الخروج بنجاح"

## الأمان

### معالجة الأخطاء:
- حتى لو فشل التحقق من التوكن، تتم عملية الخروج
- في حالة فشل API call، يتم تسجيل خروج محلي
- جميع الأخطاء يتم تسجيلها في console

### حماية البيانات:
- حذف كامل للجلسات من قاعدة البيانات
- إزالة جميع البيانات من localStorage
- تعيين maxAge: 0 للكوكيز لحذفها فوراً

## الاستخدام

### للمستخدم:
1. الدخول للوحة التحكم
2. النقر على زر "تسجيل الخروج" في الشريط العلوي
3. يتم إعادة التوجيه لصفحة تسجيل الدخول مع رسالة نجاح

### للمطور:
```typescript
// استخدام وظيفة تسجيل الخروج في أي مكان
const logout = async () => {
  await fetch('/api/auth/logout', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  localStorage.clear()
  window.location.href = '/login?logout=true'
}
```

## التحسينات المستقبلية المقترحة

1. **تأكيد تسجيل الخروج:** إضافة نافذة تأكيد قبل الخروج
2. **تسجيل الخروج من جميع الأجهزة:** خيار لحذف جميع الجلسات
3. **سجل تسجيل الخروج:** حفظ تاريخ عمليات الخروج
4. **تسجيل خروج تلقائي:** بعد فترة خمول محددة 